<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK Stock AI Analysis - Charts</title>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .controls {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .stock-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .stock-btn:hover, .stock-btn.active {
            background: #667eea;
            color: white;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .chart-title { 
            font-size: 1.5em; 
            font-weight: bold; 
            color: #667eea; 
        }
        .chart-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .stat {
            text-align: center;
        }
        .stat-label {
            font-size: 0.8em;
            color: #6c757d;
        }
        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
        }
        #priceChart { 
            height: 400px; 
            position: relative;
        }
        #volumeChart { 
            height: 150px; 
            margin-top: 10px;
            position: relative;
        }
        .prediction-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .prediction-title { 
            font-size: 1.2em; 
            margin-bottom: 15px;
            font-weight: bold;
        }
        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .prediction-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
        }
        .prediction-value { 
            font-size: 1.8em; 
            font-weight: bold;
            margin: 5px 0;
        }
        .positive { color: #4caf50; }
        .negative { color: #f44336; }
        .neutral { color: #ffa726; }
        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
        }
        .error {
            color: #f44336;
            padding: 20px;
            text-align: center;
        }
        .ai-reasoning {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            font-size: 0.95em;
            line-height: 1.5;
        }
    </style>
</head>
<body>
	<!-- Add this navigation bar right after <body> tag -->
	<div style="background: rgba(255,255,255,0.95); padding: 10px 20px; margin-bottom: 20px; border-radius: 0 0 10px 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
		<div style="max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
        	<div style="display: flex; gap: 20px;">
            	<a href="home.html" style="text-decoration: none; color: #667eea; font-weight: bold; padding: 8px 16px; border-radius: 5px; transition: all 0.3s; background: rgba(102, 126, 234, 0.1);">
                üè† Home
            	</a>
            	<a href="index.html" style="text-decoration: none; color: #667eea; font-weight: bold; padding: 8px 16px; border-radius: 5px; transition: all 0.3s; background: rgba(102, 126, 234, 0.2);">
                üìä Dashboard
           		</a>
            	<a href="charts.html" style="text-decoration: none; color: #667eea; font-weight: bold; padding: 8px 16px; border-radius: 5px; transition: all 0.3s;">
                üìà Charts
            	</a>
        	</div>
        	<div style="color: #667eea; font-weight: bold;">
            HK Stock AI Platform
        	</div>
    	</div>
	</div>
    <div class="container">
        <h1>üìà HK Stock AI Analysis - Advanced Charts</h1>
        
        <div class="controls">
            <button class="stock-btn active" onclick="loadStock('0700.HK', 'Tencent')">Tencent</button>
            <button class="stock-btn" onclick="loadStock('9988.HK', 'Alibaba')">Alibaba</button>
            <button class="stock-btn" onclick="loadStock('0005.HK', 'HSBC')">HSBC</button>
            <button class="stock-btn" onclick="loadStock('0941.HK', 'China Mobile')">China Mobile</button>
            <button class="stock-btn" onclick="loadStock('1299.HK', 'AIA')">AIA</button>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title" id="chartTitle">Loading...</div>
                <div class="chart-stats">
                    <div class="stat">
                        <div class="stat-label">Current Price</div>
                        <div class="stat-value" id="currentPrice">-</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Change</div>
                        <div class="stat-value" id="priceChange">-</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">RSI</div>
                        <div class="stat-value" id="rsi">-</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Volume</div>
                        <div class="stat-value" id="volume">-</div>
                    </div>
                </div>
            </div>
            <div id="priceChart"></div>
            <div id="volumeChart"></div>
        </div>
        
        <div class="prediction-box">
            <div class="prediction-title">ü§ñ AI Price Prediction (5-Day Forecast)</div>
            <div id="predictionContent">
                <div class="loading">Loading AI prediction...</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8000';
        
        // Global variables
        let priceChart = null;
        let volumeChart = null;
        let priceSeries = null;
        let volumeSeries = null;
        let smaSeries = null;
        let currentSymbol = '0700.HK';
        let currentName = 'Tencent';

        // Main function to load stock data
        async function loadStock(symbol, name) {
            console.log(`Loading ${name} (${symbol})...`);
            
            currentSymbol = symbol;
            currentName = name;
            
            // Update active button
            document.querySelectorAll('.stock-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === name) {
                    btn.classList.add('active');
                }
            });
            
            // Update title
            document.getElementById('chartTitle').textContent = `Loading ${name}...`;
            
            try {
                // Fetch all required data
                const [histData, analysisData, predictionData] = await Promise.all([
                    fetchWithTimeout(`${API_BASE}/stock/${symbol}/history?days=30`),
                    fetchWithTimeout(`${API_BASE}/analysis/${symbol}`),
                    fetchWithTimeout(`${API_BASE}/prediction/${symbol}`)
                ]);
                
                console.log('Data loaded successfully');
                
                // Update the UI with fetched data
                updateHeader(symbol, name, analysisData);
                drawCharts(histData);
                updatePrediction(predictionData);
                
            } catch (error) {
                console.error('Error loading stock data:', error);
                document.getElementById('chartTitle').textContent = `Error loading ${name}`;
                document.getElementById('priceChart').innerHTML = `<div class="error">Failed to load data: ${error.message}</div>`;
                document.getElementById('predictionContent').innerHTML = `<div class="error">Prediction unavailable</div>`;
            }
        }

        // Helper function for fetch with timeout
        async function fetchWithTimeout(url, timeout = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        // Update header information
        function updateHeader(symbol, name, analysis) {
            document.getElementById('chartTitle').textContent = `${symbol} - ${name}`;
            document.getElementById('currentPrice').textContent = `$${(analysis.price || 0).toFixed(2)}`;
            
            const changeElement = document.getElementById('priceChange');
            const change = analysis.price_change || 0;
            changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
            changeElement.className = `stat-value ${change >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('rsi').textContent = (analysis.rsi || 0).toFixed(1);
            
            // Format volume
            const volume = analysis.volume || 0;
            const volumeFormatted = volume > 1000000 ? `${(volume / 1000000).toFixed(1)}M` : `${Math.floor(volume / 1000)}K`;
            document.getElementById('volume').textContent = volumeFormatted;
        }

        // Draw price and volume charts
        // Draw price and volume charts
	function drawCharts(histData) {
		if (!histData || !histData.data || histData.data.length === 0) {
			document.getElementById('priceChart').innerHTML = '<div class="error">No historical data available</div>';
			return;
		}
	
		// Clear existing charts
		const priceContainer = document.getElementById('priceChart');
		const volumeContainer = document.getElementById('volumeChart');
		priceContainer.innerHTML = '';
		volumeContainer.innerHTML = '';
		
		// Check if LightweightCharts is loaded
		if (typeof LightweightCharts === 'undefined') {
			console.error('LightweightCharts library not loaded');
			priceContainer.innerHTML = '<div class="error">Chart library not loaded</div>';
			return;
		}
		
		// Create price chart using the global object
		priceChart = window.LightweightCharts.createChart(priceContainer, {
			width: priceContainer.offsetWidth,
			height: 400,
			layout: {
				backgroundColor: '#ffffff',
				textColor: '#333333',
			},
			grid: {
				vertLines: {
                color: '#e0e0e0',
			},
			horzLines: {
                color: '#e0e0e0',
            },
		},
	});
    
    // Use the simple area series which always works
    const areaSeries = priceChart.addAreaSeries({
        topColor: 'rgba(33, 150, 243, 0.56)',
        bottomColor: 'rgba(33, 150, 243, 0.04)',
        lineColor: 'rgba(33, 150, 243, 1)',
        lineWidth: 2,
    });
    
    // Prepare and set data
    const priceData = histData.data.map(item => ({
        time: item.date,
        value: item.close
    }));
    
    areaSeries.setData(priceData);
    
    // Create volume chart
    volumeChart = window.LightweightCharts.createChart(volumeContainer, {
        width: volumeContainer.offsetWidth,
        height: 150,
        layout: {
            backgroundColor: '#ffffff',
            textColor: '#333333',
        },
    });
    
    // Add histogram series for volume
    const volumeSeries = volumeChart.addHistogramSeries({
        color: '#26a69a',
        priceFormat: {
            type: 'volume',
        },
    });
    
    // Set volume data
    const volumeData = histData.data.map(item => ({
        time: item.date,
        value: item.volume,
        color: item.close >= item.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)'
    }));
    
    volumeSeries.setData(volumeData);
    
    // Fit content
    priceChart.timeScale().fitContent();
    volumeChart.timeScale().fitContent();
}

        // Update prediction box
        function updatePrediction(prediction) {
            const content = document.getElementById('predictionContent');
            
            if (!prediction || prediction.error) {
                content.innerHTML = '<div class="error">AI prediction unavailable</div>';
                return;
            }
            
            const trend = prediction.predicted_trend || 'NEUTRAL';
            const confidence = (prediction.confidence || 0) * 100;
            const target = prediction.price_target || 0;
            const current = prediction.current_price || 0;
            const changePercent = current > 0 ? ((target - current) / current * 100) : 0;
            
            const trendClass = trend === 'BULLISH' ? 'positive' : 
                               trend === 'BEARISH' ? 'negative' : 'neutral';
            
            content.innerHTML = `
                <div class="prediction-grid">
                    <div class="prediction-item">
                        <div class="stat-label">Predicted Trend</div>
                        <div class="prediction-value ${trendClass}">${trend}</div>
                    </div>
                    <div class="prediction-item">
                        <div class="stat-label">Confidence Level</div>
                        <div class="prediction-value">${confidence.toFixed(0)}%</div>
                    </div>
                    <div class="prediction-item">
                        <div class="stat-label">Target Price (5 days)</div>
                        <div class="prediction-value">$${target.toFixed(2)}</div>
                    </div>
                    <div class="prediction-item">
                        <div class="stat-label">Expected Change</div>
                        <div class="prediction-value ${changePercent >= 0 ? 'positive' : 'negative'}">
                            ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%
                        </div>
                    </div>
                </div>
                <div class="ai-reasoning">
                    <strong>AI Analysis:</strong> ${prediction.reasoning || 'Based on technical indicators, historical patterns, and market sentiment analysis.'}
                </div>
            `;
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            if (priceChart) {
                priceChart.applyOptions({ 
                    width: document.getElementById('priceChart').offsetWidth 
                });
            }
            if (volumeChart) {
                volumeChart.applyOptions({ 
                    width: document.getElementById('volumeChart').offsetWidth 
                });
            }
        });

        // Initialize with first stock
        window.addEventListener('DOMContentLoaded', () => {
            loadStock('0700.HK', 'Tencent');
        });

        // Auto-refresh every 5 minutes
        setInterval(() => {
            loadStock(currentSymbol, currentName);
        }, 5 * 60 * 1000);
    </script>
</body>
</html>